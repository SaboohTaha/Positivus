---
import SectionHeader from '@components/ui/SectionHeader.astro';

// Import SVG assets
import textBubble from '@assets/svgs/text_bubble.svg?url';
import slideUnselected from '@assets/svgs/icons/slide_unselected.svg?url';
import slideSelected from '@assets/svgs/icons/slide_selected.svg?url';
import arrowLeft from '@assets/svgs/arrows/arrow_slider_left.svg?url';
import arrowRight from '@assets/svgs/arrows/arrow_slider_right.svg?url';

const testimonials = [
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
];
---

<section id="testimonials" class="my-[60px] md:my-[100px] bg-white overflow-hidden">
  <SectionHeader 
    title="Testimonials"
    description="Hear from Our Satisfied Clients: Read Our Testimonials to Learn More about Our Digital Marketing Services"
    descriptionMaxWidth="473px"
  />

  <div class="max-w-[1440px] mx-auto px-[20px] md:px-[100px]">
    <!-- Main Dark Container -->
    <div class="bg-[#191A23] rounded-[45px] py-[40px] md:py-[84px] relative overflow-hidden">
      
      <!-- Horizontal Slider Wrapper -->
      <div 
        id="testimonial-container"
        class="flex flex-row overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-[20px] md:gap-[50px] px-[20px] transition-all"
        style="scrollbar-width: none; -ms-overflow-style: none;"
      >
        {testimonials.map((t, index) => (
          <div class="testimonial-card flex-shrink-0 w-[300px] md:w-[606px] snap-center flex flex-col gap-[20px] items-start transition-opacity duration-300">
            <!-- Bubble Background  -->
            <div class="relative w-full aspect-[606/266] flex items-center justify-center px-[30px] md:px-[52px] pb-[30px] md:pb-[48px]">
              <!-- The SVG Bubble Wrapper -->
              <div class="absolute inset-0 pointer-events-none">
                <img src={textBubble} alt="" class="w-full h-full object-fill" />
              </div>
              
              <!-- Testimonial Text -->
              <p class="relative z-10 m-0 font-sans font-normal text-[14px] md:text-[18px] leading-[20px] md:leading-[23px] text-white text-center md:text-left max-w-[502px]">
                "{t.text}"
              </p>
            </div>

            <!-- Author Info -->
            <div class="flex flex-col ml-[60px] md:ml-[70px]">
              <h4 class="m-0 font-sans font-medium text-[16px] md:text-[20px] leading-[22px] md:leading-[26px] text-[#B9FF66]">
                {t.name}
              </h4>
              <p class="m-0 font-sans font-normal text-[14px] md:text-[18px] leading-[20px] md:leading-[23px] text-white">
                {t.role}
              </p>
            </div>
          </div>
        ))}
      </div>

      <!-- Navigation & Pagination -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-[40px] md:gap-[150px] lg:gap-[189px] mt-[60px] md:mt-[124px] px-[20px]">
        
        <!-- Controls Container -->
        <div class="flex flex-row items-center gap-[40px] md:gap-[100px]">
          <!-- Arrow Left -->
          <button id="prev-testimonial" class="p-2 border-none bg-transparent cursor-pointer group transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed">
            <img src={arrowLeft} alt="Previous" class="w-[20px] md:w-[23px] group-hover:scale-110 transition-transform" />
          </button>

          <!-- Navigation indicators (Pagination) -->
          <div class="flex flex-row gap-[10px] md:gap-[18px]">
            {testimonials.map((_, i) => (
              <div 
                class="testimonial-dot-btn w-[14px] h-[14px] cursor-pointer transition-all duration-300 transform hover:scale-125"
                data-index={i}
              >
                <img 
                  src={i === 0 ? slideSelected : slideUnselected} 
                  alt={`Slide ${i + 1}`} 
                  class="dot-icon w-full h-full"
                  data-selected={slideSelected}
                  data-unselected={slideUnselected}
                />
              </div>
            ))}
          </div>

          <!-- Arrow Right -->
          <button id="next-testimonial" class="p-2 border-none bg-transparent cursor-pointer group transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed">
            <img src={arrowRight} alt="Next" class="w-[20px] md:w-[23px] group-hover:scale-110 transition-transform" />
          </button>
        </div>

      </div>
    </div>
  </div>
</section>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('testimonial-container');
    const prevBtn = document.getElementById('prev-testimonial');
    const nextBtn = document.getElementById('next-testimonial');
    const dotBtns = document.querySelectorAll('.testimonial-dot-btn');
    const dots = document.querySelectorAll('.dot-icon');

    const updateUI = () => {
      const scrollLeft = container.scrollLeft;
      const scrollWidth = container.scrollWidth;
      const clientWidth = container.clientWidth;
      
      // Calculate active index based on snap positions
      const card = container.querySelector('.testimonial-card');
      const cardWidth = card.offsetWidth + parseInt(getComputedStyle(container).gap);
      const activeIndex = Math.round(scrollLeft / cardWidth);

      // Update Dots
      dots.forEach((dot, i) => {
        const selected = dot.getAttribute('data-selected');
        const unselected = dot.getAttribute('data-unselected');
        dot.src = i === activeIndex ? selected : unselected;
      });

      // Update Arrows Opacity/Disabled State
      if (prevBtn) prevBtn.disabled = scrollLeft <= 5;
      if (nextBtn) nextBtn.disabled = scrollLeft + clientWidth >= scrollWidth - 5;
    };

    // Custom smooth scroll function with duration
    const smoothScrollTo = (target, duration) => {
      const start = container.scrollLeft;
      const change = target - start;
      const startTime = performance.now();
      
      // Temporarily disable snap to allow smooth JS animation
      container.style.scrollSnapType = 'none';

      const animateScroll = (currentTime) => {
        const timeElapsed = currentTime - startTime;
        const progress = Math.min(timeElapsed / duration, 1);
        
        // easeInOutQuad easing
        const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
        
        container.scrollLeft = start + change * ease;

        if (timeElapsed < duration) {
          requestAnimationFrame(animateScroll);
        } else {
          // Re-enable snap after animation finishes
          container.style.scrollSnapType = 'x mandatory';
          updateUI();
        }
      };

      requestAnimationFrame(animateScroll);
    };

    const getCardWidth = () => {
      const card = container.querySelector('.testimonial-card');
      return card.offsetWidth + parseInt(getComputedStyle(container).gap);
    };

    // Click navigation
    prevBtn?.addEventListener('click', () => {
      const target = container.scrollLeft - getCardWidth();
      smoothScrollTo(target, 500); // 0.5s
    });

    nextBtn?.addEventListener('click', () => {
      const target = container.scrollLeft + getCardWidth();
      smoothScrollTo(target, 500); // 0.5s
    });

    // Dot click
    dotBtns.forEach((btn, i) => {
      btn.addEventListener('click', () => {
        smoothScrollTo(i * getCardWidth(), 500);
      });
    });

    // Scroll listener for UI updates (dots/arrows)
    container?.addEventListener('scroll', () => {
      requestAnimationFrame(updateUI);
    });

    // Initial state
    setTimeout(updateUI, 100);
    
    // Resize listener for responsive widths
    window.addEventListener('resize', updateUI);
  });
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  /* Centering the slider content so first/last cards can be centered with siblings visible */
  @media (min-width: 768px) {
    #testimonial-container {
      /* Padding calculation: (Full Container Width - Single Card Width) / 2 */
      /* Full width is 1240px (at max-w 1440 - 200 padding) */
      /* Single card is 606px. Gap is 50px. */
      padding-left: calc(50% - 303px);
      padding-right: calc(50% - 303px);
    }
  }

  /* Testimonial card visibility */
  #testimonial-container::-webkit-scrollbar {
    display: none;
  }
</style>
