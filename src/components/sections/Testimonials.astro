---
import SectionHeader from '@components/ui/SectionHeader.astro';
import TestimonialTail from '@components/svgs/TestimonialTail.astro';

// Import SVG assets
import textBubble from '@assets/svgs/text_bubble.svg?url';
import slideUnselected from '@assets/svgs/icons/slide_unselected.svg?url';
import slideSelected from '@assets/svgs/icons/slide_selected.svg?url';
import arrowLeft from '@assets/svgs/arrows/arrow_slider_left.svg?url';
import arrowRight from '@assets/svgs/arrows/arrow_slider_right.svg?url';

const testimonials = [
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
  {
    name: "John Smith",
    role: "Marketing Director at XYZ Corp",
    text: "We have been working with Positivus for the past year and have seen a significant increase in website traffic and leads as a result of their efforts. The team is professional, responsive, and truly cares about the success of our business. We highly recommend Positivus to any company looking to grow their online presence."
  },
];
---

<section id="testimonials" class="my-[60px] md:my-container-padding bg-white overflow-hidden">
  <SectionHeader 
    title="Testimonials"
    description="Hear from Our Satisfied Clients: Read Our Testimonials to Learn More about Our Digital Marketing Services"
    descriptionMaxWidth="473px"
  />

  <div class="max-w-[1440px] mx-auto px-[20px] md:px-container-padding">
    <!-- Main Dark Container -->
    <div class="bg-[#191A23] rounded-[45px] py-[40px] md:py-[84px] relative overflow-hidden">
      
      <!-- Horizontal Slider Wrapper -->
      <div 
        id="testimonial-container"
        class="flex flex-row overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-[20px] md:gap-[50px] px-[20px] transition-all"
        style="scrollbar-width: none; -ms-overflow-style: none;"
      >
        {testimonials.map((t, index) => (
          <div class="testimonial-card shrink-0 w-[280px] md:w-[606px] snap-center flex flex-col gap-[40px] md:gap-[48px] items-start transition-opacity duration-300">
            <!-- Dynamic Bubble Container -->
            <div class="relative w-full border-2 border-[#B9FF66] rounded-[45px] px-[30px] md:px-[52px] py-[30px] md:py-[48px] min-h-[160px] flex items-center">
              
              <!-- Testimonial Text -->
              <p class="relative z-10 m-0 font-sans font-normal text-[14px] md:text-[18px] leading-[20px] md:leading-[23px] text-white text-center md:text-left">
                "{t.text}"
              </p>

              <!-- SVG Tail - Dynamic Component -->
              <TestimonialTail className="absolute -bottom-[28px] left-[50px] md:left-[60px]" />
            </div>

            <!-- Author Info -->
            <div class="flex flex-col ml-[60px] md:ml-[70px]">
              <h4 class="m-0 font-sans font-medium text-[16px] md:text-[20px] leading-[22px] md:leading-[26px] text-[#B9FF66]">
                {t.name}
              </h4>
              <p class="m-0 font-sans font-normal text-[14px] md:text-[18px] leading-[20px] md:leading-[23px] text-white">
                {t.role}
              </p>
            </div>
          </div>
        ))}
      </div>

      <!-- Navigation & Pagination -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-[40px] md:gap-[150px] lg:gap-[189px] mt-[60px] md:mt-[124px] px-[20px]">
        
        <!-- Controls Container -->
        <div class="flex flex-row items-center gap-[40px] md:gap-container-padding">
          <!-- Arrow Left -->
          <button id="prev-testimonial" class="p-2 border-none bg-transparent cursor-pointer group transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed">
            <img src={arrowLeft} alt="Previous" class="w-[20px] md:w-[23px] group-hover:scale-110 transition-transform" />
          </button>

          <!-- Navigation indicators (Pagination) -->
          <div class="flex flex-row gap-[10px] md:gap-[18px]">
            {testimonials.map((_, i) => (
              <div 
                class="testimonial-dot-btn w-[14px] h-[14px] cursor-pointer transition-all duration-300 transform hover:scale-125"
                data-index={i}
              >
                <img 
                  src={i === 0 ? slideSelected : slideUnselected} 
                  alt={`Slide ${i + 1}`} 
                  class="dot-icon w-full h-full"
                  data-selected={slideSelected}
                  data-unselected={slideUnselected}
                />
              </div>
            ))}
          </div>

          <!-- Arrow Right -->
          <button id="next-testimonial" class="p-2 border-none bg-transparent cursor-pointer group transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed">
            <img src={arrowRight} alt="Next" class="w-[20px] md:w-[23px] group-hover:scale-110 transition-transform" />
          </button>
        </div>

      </div>
    </div>
  </div>
</section>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('testimonial-container');
    const prevBtn = document.getElementById('prev-testimonial');
    const nextBtn = document.getElementById('next-testimonial');
    const dotBtns = document.querySelectorAll('.testimonial-dot-btn');
    const dots = document.querySelectorAll('.dot-icon');

    const updateUI = () => {
      const scrollLeft = container.scrollLeft;
      const containerWidth = container.offsetWidth;
      const scrollWidth = container.scrollWidth;
      
      // Calculate active index based on which card's center is closest to container center
      const cards = container.querySelectorAll('.testimonial-card');
      let activeIndex = 0;
      let minDistance = Infinity;

      cards.forEach((card, i) => {
        const cardCenter = card.offsetLeft + (card.offsetWidth / 2);
        const containerCenter = scrollLeft + (containerWidth / 2);
        const distance = Math.abs(cardCenter - containerCenter);
        
        if (distance < minDistance) {
          minDistance = distance;
          activeIndex = i;
        }
      });

      // Update Dots
      dots.forEach((dot, i) => {
        const selected = dot.getAttribute('data-selected');
        const unselected = dot.getAttribute('data-unselected');
        dot.src = i === activeIndex ? selected : unselected;
      });

      // Update Arrows Opacity/Disabled State
      // Use a small buffer for precision
      if (prevBtn) prevBtn.disabled = activeIndex === 0;
      if (nextBtn) nextBtn.disabled = activeIndex === cards.length - 1;
    };

    // Custom smooth scroll function with duration
    const smoothScrollTo = (index, duration) => {
      const cards = container.querySelectorAll('.testimonial-card');
      const targetCard = cards[index];
      if (!targetCard) return;

      const containerWidth = container.offsetWidth;
      const targetScrollLeft = targetCard.offsetLeft - (containerWidth / 2) + (targetCard.offsetWidth / 2);
      
      const start = container.scrollLeft;
      const change = targetScrollLeft - start;
      const startTime = performance.now();
      
      // Temporarily disable snap to allow smooth JS animation
      container.style.scrollSnapType = 'none';

      const animateScroll = (currentTime) => {
        const timeElapsed = currentTime - startTime;
        const progress = Math.min(timeElapsed / duration, 1);
        
        // easeInOutQuad easing
        const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
        
        container.scrollLeft = start + change * ease;

        if (timeElapsed < duration) {
          requestAnimationFrame(animateScroll);
        } else {
          // Re-enable snap after animation finishes
          container.style.scrollSnapType = 'x mandatory';
          updateUI();
        }
      };

      requestAnimationFrame(animateScroll);
    };

    const getCurrentIndex = () => {
      const scrollLeft = container.scrollLeft;
      const containerWidth = container.offsetWidth;
      const cards = container.querySelectorAll('.testimonial-card');
      let activeIndex = 0;
      let minDistance = Infinity;

      cards.forEach((card, i) => {
        const cardCenter = card.offsetLeft + (card.offsetWidth / 2);
        const containerCenter = scrollLeft + (containerWidth / 2);
        const distance = Math.abs(cardCenter - containerCenter);
        if (distance < minDistance) {
          minDistance = distance;
          activeIndex = i;
        }
      });
      return activeIndex;
    };

    // Click navigation
    prevBtn?.addEventListener('click', () => {
      const currentIndex = getCurrentIndex();
      if (currentIndex > 0) {
        smoothScrollTo(currentIndex - 1, 500);
      }
    });

    nextBtn?.addEventListener('click', () => {
      const currentIndex = getCurrentIndex();
      const cards = container.querySelectorAll('.testimonial-card');
      if (currentIndex < cards.length - 1) {
        smoothScrollTo(currentIndex + 1, 500);
      }
    });

    // Dot click
    dotBtns.forEach((btn, i) => {
      btn.addEventListener('click', () => {
        smoothScrollTo(i, 500);
      });
    });

    // Scroll listener for UI updates (dots/arrows)
    container?.addEventListener('scroll', () => {
      requestAnimationFrame(updateUI);
    });

    // Initial state
    setTimeout(updateUI, 100);
    
    // Resize listener for responsive widths
    window.addEventListener('resize', updateUI);
  });
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  /* Centering the slider content so first/last cards can be centered with siblings visible */
  #testimonial-container {
    /* (Full Container Width - Single Card Width) / 2 */
    padding-left: calc(50% - 140px);
    padding-right: calc(50% - 140px);
  }

  @media (min-width: 768px) {
    #testimonial-container {
      padding-left: calc(50% - 303px);
      padding-right: calc(50% - 303px);
    }
  }

  /* Testimonial card visibility */
  #testimonial-container::-webkit-scrollbar {
    display: none;
  }
</style>
